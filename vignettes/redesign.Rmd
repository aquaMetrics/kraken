---
title: "Redesign"
output: html_document
date: "2022-09-29"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(kraken)
library(aquaman)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
```

## Standardise Data

### Import Survey Details Template

```{r}
file <- system.file("extdat",
  "survey-template/220421-SelfMon-N4952-CAV1-Enhanced.xlsx",
  package =
    "aquaman"
)
survey <- survey_import(file)

survey_data <- survey %>%
  filter(question %in% c(
    "IQI",
    "Easting", 
    "Northing",
    "Transect",
    "Station",
    "Date sampled (dd/mm/yy)")) %>%
  mutate(
    location_id = sample_id,
    sample_id = paste0(sample_id, project_id)
  )

date <- survey_data %>%
  filter(question == "Date sampled (dd/mm/yy)") %>%
  select(sample_id, "date_taken" = response)

survey_data <- inner_join(survey_data, date, by = "sample_id")
survey_data <- survey_data %>% filter(question != "Date sampled (dd/mm/yy)")
```

### Import Access Database

```{r}
# file <- system.file("extdat",
#   "test-data/harris-iqi-data.csv",
#   package = "kraken"
# )
# 
# access_data <- readr::read_csv(file, show_col_types = FALSE)
# 
# access_data <- access_data %>%
#   mutate(
#     sample_id = paste0(Transect, Station, MCFF),
#     project_id = paste0(MCFF, Survey_date),
#     location_id = paste0(Transect, Station)
#   ) %>%
#   select(
#     -Footprint,
#     -Permit,
#     -site_name_survey_id,
#     -Site_Name,
#     -Site_ID,
#     -MCFF,
#     -Survey_ID,
#     -Transect,
#     -Station
#   ) %>%
#   pivot_longer(
#     cols = c(
#       -sample_id,
#       -Survey_date,
#       -project_id,
#       -location_id
#     ),
#     names_to = "question",
#     values_to = "response"
#   ) %>%
#   select(location_id,
#     project_id,
#     sample_id,
#     "date_taken" = Survey_date,
#     question,
#     response
#   ) %>%
#   mutate(response = as.character(response))
```

Combine Data

For instance, take data from Access database, survey details template, Ecology
recovered data or EA web services.
This all becomes One Big Table (OBT)! All data is the same, columns are the
same, data types are the same, it's boring, boring, boring.

```{r}
# data <- bind_rows(access_data, survey_data)
```


## Validation

Data validation...
Transect level:
1. Number of stations
2. No. of transects
3. Reaching good status
4. Warnings: Proxy transects
5. Warnings: Type of proxy transects
6. Warnings: Pen groupings
7. 150-200m third...??



```{r}
valid <- function(data) {
  # ...
  # map_df(split(transect), function() {
  #
  #
  #
  # })
  # number_of_stations <- tibble(
  #   question =  "Number of stations",
  #   response = ""
  # )
  #
  #
  # bind_rows(data, validation)
  return(data)
}

data <- valid(survey_data)
```


## WFD Status

Need a generic function for assigning WFD status to ratio or observation...luckily we already programmed one.

```{r}
wfd_status <- function(data, question) {
  eqr <- data[data$question ==  question, ]
  eqr <- eqr[!is.na(eqr$response), ]
  eqr$response <- as.numeric(eqr$response)
  status <- purrr::map_df(split(eqr, unique(eqr$sample_id)), function(sample) {
    # Copy from RICT...
    class <- rict::compare_probability(
      a = sample$response,
      b = sample$response,
      eqr_bands =
        c(
          0,
          0.47,
          0.56,
          0.64,
          0.8,
          1
        )
    )
    sample$response <- class$`Most Probable Class for Result A`
    sample$question <- "status"
    sample$status <- as.character(sample$response)
    return(sample)
  })

  data <- dplyr::bind_rows(data, status)
  return(data)
}

wfd_data <- wfd_status(data,
  question = "IQI"
)
```

## GIS Attributes

Add GIS attributes

```{r}
gis_attributes <- function(data) {
  geo_data <- data %>%
    filter(question == "Easting" | question == "Northing") %>%
    distinct()

  geo_data <- pivot_wider(
    geo_data,
    names_from = question,
    values_from = response
  )

  lat_lon <- kraken:::convert_coordinates(
    geo_data$Easting,
    geo_data$Northing
  )
  lat_lon$sample_id <- geo_data$sample_id
  data <- inner_join(data, lat_lon, by = join_by(sample_id))
  return(data)
}

gis_data <- gis_attributes(wfd_data)
```

## Distance to Good

```{r}
# distance <- function(data) {
#    transect_data <- data %>%
#     filter(question == "Transect") %>%
#     distinct()
# 
#   transect_data <- pivot_wider(
#     transect_data,
#     names_from = question,
#     values_from = response
#   )
#   
#   
#   purrr::map_df(split(data, data$Transect), function(transect){
#     
#     
#      
#   return(data)
#   })
#   
#  
# }
# 
# distance_data <- distance(gis_data)
```

## Area

```{r}
# area <- function(data) {
#   return(data)
# }
# area_data <- distance(distance_data)
```

## Overall Calculation

Wrap all the sub functions into an overall `kraken()` function.

```{r}
# `question` - What is be categorized e.g. IQI, emermectin, phosphorus, diatoms...
# kraken <- function(data, question, eqr_bands) {
#   wfd <- wfd_status(
#     data,
#     question,
#     eqr_bands
#   )
#   gis <- gis_attributes(wfd)
#   distance <- distance(gis)
#   area <- area(distance)
# 
#   return(area)
# }
# 
# 
# output <- kraken(data,
#   question = "IQI",
#   eqr_bands = c(
#     0,
#     0.24,
#     0.44,
#     0.64,
#     0.75,
#     1
#   )
# )
```
