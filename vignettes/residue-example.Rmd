---
title: "Residue Example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Residue Example}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(kraken)
library(dplyr)
library(tidyr)
library(ggplot2)
library(drc)
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

## Data

Export data from fish farm database as .csv file. Save locally and use the 'Import Dataset' tool in the Environment pane to import data or use `read.csv()` function and paste in file path - but replace  '\' with '/' in the path.

```{r data}
data <- read.csv(system.file("extdat/test-data/", "residue-test-data.csv", package = "kraken"))

# data <- read.csv("C:/Users/Tim.Foster/OneDrive - Scottish Environment Protection Agency/DNA Data/Readiness Data/ellipse-area/survey-5326.csv")

# Filter data for my particular farm/date of interest
data <- dplyr::filter(data, Site.ID == "BELL1")

# Select only the columns needed for calculations
data <- dplyr::select(data,
  EQS..ng.kg.,
  "Survey_date" = Survey.Date,
  "MCFF" = Site.ID,
  Transect,
  "Station" = Station.Order..transect.,
  Easting,
  Northing,
  "Embz-1" = EmBz.residues..Rep.1...ng.kg.,
  "Embz-2" = EmBz.residues..Rep.2..ng.kg.,
  "Embz-3" = EmBz.residues..Rep.3..ng.kg.
)

# Pivot the data into structure require for calculations
data <- tidyr::pivot_longer(
  data,
  cols = c("Embz-1", "Embz-2", "Embz-3"),
  names_to = "Station_id", values_to = "IQI"
)

data$IQI <- as.numeric(data$IQI)
pass_fail <- unique(data$EQS..ng.kg.)
```


## Calculate

Run data through calculations.

```{r run-kraken}
output <- kraken::kraken(data,
  pass_fail = pass_fail,
  method = "residue",
  loess = FALSE, n_try = 10
)
```

## Map

```{r map}
map <- output$object[output$question == "map"]
map
```

## Including Plots

Need to create a plot of the regression line based on the optimal model fitted...
Bit complicated...find which model has been used for each transect

```{r model}
model <- output$object[output$question == "model_info"][[1]]
model
```

Model: 'Regression model fit not of sufficient quality to use' - not sure why?
Is the model struggling to fit? Wasn't a problem with earlier test data?

```{r plots, eval=FALSE}
# pivot output
plots_data <- output %>% dplyr::filter(grepl("BELL1", location_id))
plots_data <- plots_data %>% 
  dplyr::filter(question %in% c("Distance", "IQI", "MCFF_Transect"))
plots_data <- distinct(plots_data)

plots_data <- purrr::map_df(
  split(plots_data, plots_data$sample_id), function(sample) {
  
  
  
  return(sample)
})


plots_data <- pivot_wider(plots_data, names_from = question, 
                          values_from = response)
plots_data$IQI <- as.numeric(plots_data$IQI)
plots_data$Distance <- as.numeric(plots_data$Distance)

p <- list()
for(i in 1:nrow(model)) {
  model_plot <- model[model$Transect == i, ]
  plot_data <- plots_data[grepl(paste0("- ",i), plots_data$MCFF_Transect), ]
  model_type <- paste0(trimws(substr(model_plot$bestModel,1,4)), "()")
  message(model_type)
  if(model_type == "Regr()") {
  p[[i]] <- ggplot(aes(Distance, IQI), data = plot_data) +
  geom_point() +
  # geom_smooth(method = "lm", linetype = 2) +
  ylab("Emmamectin PPM") +
  ggplot2::ggtitle(paste0("Site: ", unique(plot_data$project_id)),
                       subtitle = paste0(unique(plot_data$MCFF_Transect),
                                         " Model fit not of sufficient quality to use")) +
#  facet_wrap(vars(MCFF_Transect)) +
  geom_hline(yintercept = pass_fail, colour = "green", linetype = 2)
    } else {
  p[[i]] <- ggplot(aes(Distance, IQI), data = plot_data) +
  geom_point() +
  geom_smooth(method = drm,
              method.args = list(fct = eval(parse(text=model_type))),
              se = FALSE) +
  ylab("Emmamectin PPM") +
  ggtitle(paste0("Site: ", unique(plot_data$project_id)), 
          subtitle = unique(plot_data$MCFF_Transect)) +
  geom_hline(yintercept = pass_fail, colour = "green", linetype = 2)
      }
}



```


```{r, eval=FALSE}

output$response[output$question == "area_95_confidence"]

(100/ 196238 )  * 327687.555651631



```


